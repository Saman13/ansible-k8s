---

- name: create sertificate directory
  ansible.builtin.file:
    path: /home/{{ kubernetes_user }}/.kube
    state: directory
    mode: "0755"

- name: Ganerate config admin (set cluster)
  ansible.builtin.command: >
    kubectl config set-cluster k8s
    --certificate-authority={{ kubernetes_dir }}/ca.crt
    --embed-certs=true
    --server=https://127.0.0.1:6443
    --kubeconfig=/home/{{ kubernetes_user }}/.kube/admin.kubeconfig

- name: Ganerate config admin (set credentials)
  ansible.builtin.command: >
    kubectl config set-credentials admin
    --client-certificate={{ kubernetes_dir }}/admin.crt
    --client-key={{ kubernetes_dir }}/admin.key
    --embed-certs=true
    --kubeconfig=/home/{{ kubernetes_user }}/.kube/admin.kubeconfig

- name: Ganerate config admin (set context)
  ansible.builtin.command: >
    kubectl config set-context default
    --cluster=k8s
    --user=admin
    --kubeconfig=/home/{{ kubernetes_user }}/.kube/admin.kubeconfig

- name: Set default context for admin config
  ansible.builtin.command: >
    kubectl config use-context default
    --kubeconfig=/home/{{ kubernetes_user }}/.kube/admin.kubeconfig


- name: Ganerate config for services (set cluster)
  ansible.builtin.command: >
    kubectl config set-cluster k8s
    --certificate-authority={{ kubernetes_dir }}/ca.crt
    --embed-certs=true
    --server=https://k8s-master.{{ domain_name }}:6443
    --kubeconfig=/home/{{ kubernetes_user }}/.kube/{{ item }}.kubeconfig
  with_items:
    - kube-controller-manager
    - kube-scheduler

- name: Ganerate config for services (set credentials)
  ansible.builtin.command: >
    kubectl config set-credentials system:{{ item }}
    --client-certificate={{ kubernetes_dir }}/{{ item }}.crt
    --client-key={{ kubernetes_dir }}/{{ item }}.key
    --embed-certs=true
    --kubeconfig=/home/{{ kubernetes_user }}/.kube/{{ item }}.kubeconfig
  with_items:
    - kube-controller-manager
    - kube-scheduler

- name: Ganerate config for services (set context)
  ansible.builtin.command: >
    kubectl config set-context default
    --cluster=k8s
    --user=system:{{ item }}
    --kubeconfig=/home/{{ kubernetes_user }}/.kube/{{ item }}.kubeconfig
  with_items:
    - kube-controller-manager
    - kube-scheduler

- name: Set default context for services config
  ansible.builtin.command: >
    kubectl config use-context default
    --kubeconfig=/home/{{ kubernetes_user }}/.kube/{{ item }}.kubeconfig
  with_items:
    - kube-controller-manager
    - kube-scheduler
